<script>
// registra/aggiorna il SW
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }

function parseNum(id){
  const raw = document.getElementById(id).value.trim();
  if (!raw) return NaN;
  const norm = raw.replace(',', '.');
  const v = parseFloat(norm);
  return isFinite(v) ? v : NaN;
}
function r1(x){ return (!isFinite(x)) ? "—" : (Math.round(x*10)/10); }

function update(){
  const sbp = parseNum('sbp');
  const dbp = parseNum('dbp');
  const hr  = parseNum('hr');
  const age = parseNum('age');

  let pp=null, mbp=null, dcbp=null, pp_a=null, si=null;
  if (isFinite(sbp) && isFinite(dbp) && sbp>0 && dbp>0){
    pp = sbp - dbp;
    mbp = Math.sqrt(sbp*dbp);
    dcbp = (mbp*mbp)/dbp;
    pp_a = dcbp - dbp;
  }
  if (isFinite(sbp) && isFinite(hr) && sbp>0){ si = hr/sbp; }

  let txt = "", cls = "low";
  const highPPa = (isFinite(pp_a) && pp_a < 35);
  const highPPperAge = (isFinite(age) && age>=60 && isFinite(pp) && pp < 40);
  const highSI = (isFinite(si) && si >= 1.0);

  if (highPPa || highPPperAge){
    txt = "ALTA PROB. di SV basso → Eco immediata; se instabile e PCI urgente, MCS SUGGERITO (IABP/Impella).";
    cls = "high";
  } else if ((isFinite(pp_a) && pp_a < 45) || (isFinite(age)&&age>=60 && isFinite(pp) && pp < 45) || highSI){
    txt = "PROB. INTERMEDIA → integra con clinica, lattati, eco precoce. MCS caso per caso.";
    cls = "mod";
  } else {
    txt = "BASSA PROB. di SV molto basso in base a PP. Conferma con eco.";
    cls = "low";
  }

  document.getElementById('pp').textContent   = r1(pp);
  document.getElementById('dcbp').textContent = r1(dcbp);
  document.getElementById('pp_a').textContent = r1(pp_a);

  // Se hai aggiunto il box Shock Index, aggiorna anche quello:
  const shockEl = document.getElementById('shock');
  if (shockEl) shockEl.textContent = r1(si);

  const flag = document.getElementById('flag');
  flag.className = "flag " + cls + " small";
  flag.textContent = txt;
}

// calcola su click
document.getElementById('btn').addEventListener('click', update);
// calcola anche mentre digiti
['sbp','dbp','hr','age'].forEach(id => {
  const el = document.getElementById(id);
  ['input','change','keyup','blur'].forEach(evt => el.addEventListener(evt, update));
});

// prima esecuzione
document.addEventListener('DOMContentLoaded', update);
</script>
